"use strict";!function(e){function t(e,t,s){if(E.null(e))return e;var i=t.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),a=new RegExp(i,"ig");return e.replace(a,s)}function s(e,t=B){return E.storage(e,t)}function i(e){return E.translate(e)}function a(e=-1){if(-1===e)return window.sb_current_user;window.sb_current_user=e}var n,o,r,l,c,d,u,h,g,m,f,p,v,b,_,w,y=!1,k=!1,$=document.title,C=e(window).width()<426,S=new Date,x="",A=!1,B="undefined",T=!0,j="";e.fn.extend({manualExpandTextarea:function(){var t=this[0];t.style.height="auto",t.style.maxHeight="25px",window.getComputedStyle(t),t.style.height=t.scrollHeight+"px",t.style.maxHeight="",e(t).trigger("textareaChanged")},autoExpandTextarea:function(){var t=this[0];t.addEventListener("input",function(s){e(t).manualExpandTextarea()},!1)}}),function(){var e=[].slice;String.prototype.autoLink=function(){var t,s,i,a,n,o,r;return o=/(^|[\s\n]|<[A-Za-z]*\/?>)((?:https?|ftp):\/\/[\-A-Z0-9+\u0026\u2019@#\/%?=()~_|!:,.;]*[\-A-Z0-9+\u0026@#\/%=~()_|])/gi,0<(n=1<=arguments.length?e.call(arguments,0):[]).length?(a=n[0],t=a.callback,i=function(){var e;for(s in e=[],a)r=a[s],"callback"!==s&&e.push(" "+s+"='"+r+"'");return e}().join(""),this.replace(o,function(e,s,a){return""+s+(("function"==typeof t?t(a):void 0)||"<a href='"+a+"'"+i+">"+a+"</a>")})):this.replace(o,"$1<a href='$2'>$2</a>")}}.call(this);var E={ajax:function(t,s=!1){t["login-cookie"]=this.null(this.cookie("sb-login"))?j:this.cookie("sb-login"),"user_id"in t||!a()||(t.user_id=a().id),typeof SB_LANG!=B&&(t.language=SB_LANG),e.ajax({method:"POST",url:SB_AJAX_URL,data:t}).done(e=>{let i;if(Array.isArray(e))i=e;else try{i=JSON.parse(e)}catch(s){console.log(e),E.error("Json parse error",`SBF.ajax.${t.function}`)}"success"==i[0]?0!=s&&s(i[1]):E.errorValidation(i)?0!=s&&s(i):("security-error"==i[1]&&setTimeout(function(){E.reset()},1e3),E.error(i[1]+(E.null(i[2])?"":"\nFunction name: "+i[2])+(E.null(i[3])?"":"\nError message: "+("string"==typeof i[3]?i[3]:"error"in i[3]&&"message"in i[3].error?`${i[3].error.message} in function '${i[3].error.function}'`:i[3])),`SBF.ajax.${t.function}`))})},cors:function(e="GET",t,s){var i=new XMLHttpRequest;if("withCredentials"in i)i.open(e,t,!0);else{if(typeof XDomainRequest==B)return!1;(i=new XDomainRequest).open(e,t)}i.onload=function(){s(i.responseText)},i.onerror=function(){return!1},i.send()},upload:function(e,t){jQuery.ajax({url:SB_URL+"/include/upload.php",cache:!1,contentType:!1,processData:!1,data:e,type:"POST",success:function(e){t(e)}})},null:function(e){return void 0===e||null===e||"null"===e||!1===e||!(e.length>0||"number"==typeof e||void 0===e.length)||"undefined"===e},deactivateAll:function(){e(o).find(".sb-popup, .sb-tooltip, .sb-list .sb-menu, .sb-select ul").sbActivate(!1)},deselectAll:function(){window.getSelection?window.getSelection().removeAllRanges():document.selection&&document.selection.empty()},getURL:function(e){return decodeURIComponent((new RegExp("[?|&]"+e+"=([^&;]+?)(&|#|;|$)").exec(location.search)||[,""])[1].replace(/\+/g,"%20")||"")},restoreJson:function(e){return E.null(e)?"":e.replace(/\\n/g,"\n").replace(/\\r/g,"\r").replace(/\\t/g,"\t").replace(/\\f/g,"\f").replace(/\\'/g,"'").replace(/\\"/g,'"').replace(/\\\\/g,"\\")},stringToSlug:function(e){e=(e=e.trim()).toLowerCase();for(var t="åàáãäâèéëêìíïîòóöôùúüûñç·/_,:;",s=0,i=t.length;s<i;s++)e=e.replace(new RegExp(t.charAt(s),"g"),"aaaaaaeeeeiiiioooouuuunc------".charAt(s));return e.replace(/[^a-z0-9 -]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-").replace(/^-+/,"").replace(/-+$/,"").replace(/ /g," ")},slugToString:function(e){return(e=e.replace(/_/g," ").replace(/-/g," ")).charAt(0).toUpperCase()+e.slice(1)},random:function(){let e="";for(var t=5;t>0;--t)e+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return e},isAgent:function(e){return"agent"==e||"admin"==e||"bot"==e},beautifyTime:function(e,t=!1,s=!1){let a;if("0000-00-00 00:00:00"==e)return"";if(e.indexOf("-")>0){n=e.split(/[- :]/);a=new Date(n[0],n[1]-1,n[2],n[3],n[4],n[5])}else{var n=e.split(/[. :]/);a=new Date(n[2],n[1]-1,n[0],n[3],n[4],n[5])}let o=new Date(Date.UTC(a.getFullYear(),a.getMonth(),a.getDate(),a.getHours(),a.getMinutes(),a.getSeconds())),r=Math.round((new Date-o)/864e5)*(s?-1:1),l=[i("Sunday"),i("Monday"),i("Tuesday"),i("Wednesday"),i("Thursday"),i("Friday"),i("Saturday")],c=o.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});return r<1?(t?i("Today")+" ":"")+c:r<8?`<span>${l[o.getDay()]}</span>${t?` <span>${c}</span>`:""}`:`<span>${o.toLocaleDateString()}</span>${t?` <span>${c}</span>`:""}`},getLocationTimeString:function(e,t){if("timezone"in e){let s={};s.timezone=e.timezone.value,s.country="country"in e?e.country.value:s.timezone.split("/")[0].replace(/_/g," "),s.city="city"in e?e.city.value:s.timezone.split("/")[1].replace(/_/g," "),E.cors("GET","https://worldtimeapi.org/api/timezone/"+s.timezone,function(e){if(e=JSON.parse(e),E.null(e)||!E.null(e.error))E.error(e,"SBF.getLocationTimeString()"),t(responseonSuccess);else{let a=e.datetime.replace("T"," ");t(`${new Date(a.substr(0,a.indexOf("."))).toLocaleString([],{hour:"2-digit",minute:"2-digit"})} ${i("in")} ${""!=s.city?s.city:""}${""!=s.country?", "+s.country:""}`)}})}},dateDB:function(e){return"now"==e?((e=(new Date).toISOString().replace("T"," ")).indexOf(".")>0&&(e=e.substr(0,e.indexOf("."))),e):`${e.getFullYear()}-${e.getMonth()+1}-${e.getDate()} ${e.getHours()}:${e.getMinutes()}:${e.getSeconds()}`},updateUsersActivity:function(e,t,s){E.ajax({function:"update-users-last-activity",user_id:e,return_user_id:t,check_slack:!l&&v["slack-active"]},e=>{s("online"===e?"online":"offline")})},search:function(t,s){(t=t.toLowerCase())!=c?(clearTimeout(k),k=setTimeout(function(){c=t,s()},500)):e(o).find(".sb-search-btn i").sbLoading(!1)},searchClear:function(t,s){""!=e(t).next().val()&&(e(t).next().val(""),s())},error:function(t,s){throw t instanceof Error&&(t=t.message),"."==t[t.length-1]&&(t=t.slice(0,-1)),t.indexOf("Support Board Error")>-1&&(t=t.replace("Support Board Error ","").replace("]:","]")),!l||""==t||s.indexOf("update-users-last-activity")||s.startsWith("security-error")||E.dialog(`[Error] [${s}] ${t}. Check the console for more details.`,"info"),e(o).find(".sb-loading").sbLoading(!1),E.event("SBError",{message:t,function_name:s}),new Error(`Support Board Error [${s}]: ${t}.`)},errorValidation:function(e,t=!0){return Array.isArray(e)&&"validation-error"===e[0]&&(!0===t||e[1]==t)},loginForm:function(t,s=!1,a=!1){if(!e(t).sbLoading()){!1===s&&(s=e(t).closest(".sb-rich-login"));let n=e(s).find("#email input").val(),o=e(s).find("#password input").val();""==n||""==o?e(s).find(".sb-info").html(i("Please insert an email and password.")).sbActivate():(E.ajax({function:"login",email:n,password:o},n=>{0!=n&&Array.isArray(n)?!l&&this.isAgent(n[0].user_type)?(U.showErrorMessage(s,"You cannot sign in as an agent."),D.scrollBottom()):(E.loginCookie(n[1]),E.event("SBLoginForm",new M(n[0])),!1!==a&&a(n)):(e(s).find(".sb-info").html(i("Invalid email or password.")).sbActivate(),l||D.scrollBottom()),e(t).sbLoading(!1)}),e(s).find(".sb-info").html("").sbActivate(!1),e(t).sbLoading(!0))}},loginCookie:function(e){j=e,this.cookie("sb-login",e,3650,"set")},login:function(e="",t="",s="",i="",a=!1){E.ajax({function:"login",email:e,password:t,user_id:s,token:i},e=>!(0==e||!Array.isArray(e))&&(this.loginCookie(e[1]),0!=a&&a(e),!0))},logout:function(e=!0){D.stopRealTime(),this.cookie("sb-login","","","delete"),s("open-conversation",""),D.conversations=!1,a(!1),typeof sb_beams_client!==B&&sb_beams_client.stop(),E.ajax({function:"logout"},()=>{E.event("SBLogout"),e&&setTimeout(()=>{location.reload()},500)})},activeUser:function(){return a()},getActiveUser:function(e=!1,t){let i=R.login();!i&&s("wp-login")&&(this.cookie("sb-login","","","delete"),a(!1),s("wp-login","")),E.ajax({function:"get-active-user",db:e,login_app:i},e=>{if(!e)return t(),!1;if("user_type"in e)if(!l&&E.isAgent(e.user_type)){let e="You are logged in as both agent and user. Logout or use another browser, Incognito or Private mode, to login as user. Force a logout by running the function SBF.reset() in the console.";s("double-login-alert")||(s("double-login-alert",!0),alert(e)),console.warn("Support Board: "+e),E.event("SBDoubleLoginError")}else a(new M(e)),i&&v["wp-logout"]&&s("wp-login",!0),t()})},reset:function(){this.cookie("sb-login","",0,!1);try{localStorage.removeItem("support-board")}catch(e){}this.logout()},dialog:function(e,t,s){l&&sbDialogAdmin(e,t,s)},lightbox:function(t){let s=e(l?o:n).find(".sb-lightbox-media");e(s).sbActivate().find(" > div").html(t)},storage:function(e,t=B){try{if(typeof localStorage==B)return!1}catch(e){return!1}let s=localStorage.getItem("support-board");if(s=null===s?{}:JSON.parse(s),t===B)return e in s&&s[e];""==t?delete s[e]:s[e]=t,localStorage.setItem("support-board",JSON.stringify(s))},cookie:function(e,t=!1,s=!1,i="get"){let a="https:"==location.protocol?"SameSite=None;Secure":"";if("get"==i){if(!T)return this.storage(e);let t=document.cookie.split(";");for(var n=0;n<t.length;n++){for(var o=t[n];" "==o.charAt(0);)o=o.substring(1);if(0==o.indexOf(e)){let t=o.substring(e.length+1,o.length);return!this.null(t)&&t}}return!1}if("set"==i)if(T){let i=new Date;i.setTime(i.getTime()+24*s*60*60*1e3),document.cookie=e+"="+t+";expires="+i.toUTCString()+";path=/;"+a}else this.storage(e,t);else this.cookie(e)&&(T?document.cookie=e+"="+t+";expires=Thu, 01 Jan 1970 00:00:01 GMT;path=/;"+a:this.storage(e,""))},storageTime:function(e,t=!1){if(!1!==t)return 0==s(e)||S.getTime()-s(e)>36e5*t;s(e,S.getTime())},setting:function(e){return typeof v!==B&&e in v?v[e]:-1},shortcode:function(e){return N.shortcode(e)},event:function(t,s){e(document).trigger(t,s),this.setting("webhooks")&&["SBLoginForm","SBUserDeleted","SBMessageSent","SBBotMessage","SBEmailSent","SBNewMessagesReceived","SBNewConversationReceived","SBNewConversationCreated","SBActiveConversationStatusUpdated","SBSlackMessageSent","SBMessageDeleted","SBRegistrationForm","SBRichMessageSubmit","SBNewEmailAddress"].includes(t)&&E.ajax({function:"webhooks",function_name:t,parameters:s})},translate:function(e){if(E.null(v))return e;let t=v.translations;return 0!=t&&e in t?""==t[e]?e:t[e]:e},escape:function(e){return e=t(e,"<script","&lt;script"),e=t(e,"</script","&lt;/script"),e=t(e,"javascript:",""),e=t(e,"onclick=",""),e=t(e,"onerror=","")},visibilityChange:function(e=""){"hidden"==e?(l||D.stopRealTime(),D.tab_active=!1):(a()&&!l&&D.startRealTime(),D.tab_active=!0,document.title=$)},settingsStringToArray:function(e){if(this.null(e))return[];let t=[];e=e.split(",");for(var s=0;s<e.length;s++){let i=e[s].split(":");t[i[0]]="false"!=i[1]&&("true"==i[1]||i[1])}return t},openWindow:function(e,t=550,s=350){let i=screen.width/2-t/2,a=screen.height/2-s/2;return window.open(e,"targetWindow","toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width="+t+",height="+s+", top="+a+", left="+i),!1}};window.SBF=E,window.sb_current_user=!1,e.fn.sbActivate=function(t=!0){return e(this).setClass("sb-active",t),this},e.fn.sbActive=function(){return e(this).hasClass("sb-active")},e.fn.sbLoading=function(t="check"){return"check"==t?e(this).hasClass("sb-loading"):(e(this).setClass("sb-loading",t),this)},e.fn.sbTogglePopup=function(t){var s=!0;return e(this).sbActive()?(e(this).sbActivate(!1),e(o).removeClass("sb-popup-active"),s=!1):(e(o).addClass("sb-popup-active"),e(o).find(".sb-popup").sbActivate(!1),e(this).css("left",e(t).offset().left+15).sbActivate(),E.deselectAll()),s},e.fn.sbUploadFiles=function(t){let s=e(this).prop("files");for(var i=0;i<s.length;i++){let e=s[i],a=new FormData;a.append("file",e),E.upload(a,t)}e(this).value=""},e.fn.setProfile=function(t=!1,s=!1){return E.null(t)&&(t=0!=a()?a().name:""),E.null(s)&&(s=0!=a()?a().image:SB_URL+"/media/user.svg"),e(this).find("img").attr("src",s),e(this).find(".sb-name").html(t),this},e.fn.setClass=function(t,s=!0){s?e(this).addClass(t):e(this).removeClass(t)};class M{constructor(e={},t={}){this.details=e,this.extra=t,this.conversations=[],this.processArray(e)}get id(){return""==this.get("id")?this.get("user_id"):this.get("id")}get type(){return this.get("user_type")}get name(){return this.get("full_name")}get image(){return this.get("profile_image")}get language(){return""==this.getExtra("browser_language")?"":this.getExtra("browser_language").value.toLowerCase()}get(e){return"full_name"==e?"first_name"in this.details?this.details.first_name+(""!=this.details.last_name?" "+this.details.last_name:""):"":e in this.details&&!E.null(this.details[e])?this.details[e]:""}getExtra(e){return e in this.extra&&!E.null(this.extra[e])?this.extra[e]:""}set(e,t){this.details[e]=t}setExtra(e,t){this.extra[e]=t}processArray(e){if(e&&"details"in e){for(var t=0;t<e.details.length;t++)this.setExtra(e.details[t].slug,e.details[t]);delete e.details,this.details=e}}update(e){""!=this.id?E.ajax({function:"get-user",user_id:this.id,extra:!0},t=>{this.processArray(t),e()}):E.error("Missing user ID","SBUser.update")}getConversations(e=!1,t){""!=this.id?E.ajax({function:"get-user-conversations",user_id:this.id,exclude_id:t},t=>{let s=[];for(var i=0;i<t.length;i++){let e=new I([new L(t[i])],{id:t[i].conversation_id,conversation_status_code:t[i].conversation_status_code,department:t[i].department,title:t[i].title});s.push(e)}this.conversations=s,0!=e&&e(s)}):E.error("Missing user ID","SBUser.getConversations")}getConversationsCode(e=!1){let t="",s=0!=D.conversation?D.conversation.id:-1;0==e&&(e=this.conversations);for(var a=0;a<e.length;a++)e[a]instanceof I?t+=`<li ${s==e[a].id?'class="sb-active" ':""}data-conversation-status="${e[a].get("conversation_status_code")}" data-conversation-id="${e[a].id}" data-department="${e[a].get("department")}">${e[a].getCode()}</li>`:E.error("Conversation not of type SBConversation","SBUser.getConversationsCode");return""==t&&(t=`<p class="sb-no-results">${i("No conversations found.")}</p>`),t}getFullConversation(e=!1,t=!1){!1!==e?E.ajax({function:"get-conversation",conversation_id:e},e=>{let s=[];for(var i=0;i<e.messages.length;i++)s.push(new L(e.messages[i]));0!=t&&t(new I(s,e.details))}):E.error("Missing conversation ID","SBUser.getFullConversation")}getConversationByID(e){for(var t=0;t<this.conversations.length;t++)if(this.conversations[t].id==e)return this.conversations[t];return!1}addConversation(e){if(e instanceof I){let s=e.id,i=!0;for(var t=0;t<this.conversations.length;t++)if(this.conversations[t].id==s){this.conversations[t]=e,i=!1;break}return i&&this.conversations.unshift(e),i}E.error("Conversation not of type SBConversation","SBUser.addConversation")}getLastConversation(){return!this.isConversationsEmpty()&&this.conversations[this.conversations.length-1]}isConversationsEmpty(){return 0==this.conversations.length}isExtraEmpty(){return 0===Object.keys(this.extra).length&&this.extra.constructor===Object}delete(e){""!=this.id?E.ajax({function:"delete-user",user_id:this.id},()=>(E.event("SBUserDeleted",this.id),e(),!0)):E.error("Missing user ID","SBUser.delete")}}window.SBUser=M;class L{constructor(e){this.details=e,"first_name"in this.details&&(this.details.full_name=this.details.first_name+" "+this.details.last_name),this.set("payload",""!=this.get("payload")?JSON.parse(this.get("payload")):{})}get id(){return this.get("id")}get attachments(){return E.null(this.details.attachments)?[]:JSON.parse(this.details.attachments)}get(e){return e in this.details&&!E.null(this.details[e])?this.details[e]:""}set(e,t){this.details[e]=t}payload(e=!1,t=!1){if(!1!==e&&!1!==t){let s=this.get("payload");s[e]=t,this.set("payload",s)}return this.get("payload")}getCode(){let e=E.isAgent(this.details.user_type),t=l?SBAdmin.conversations.messageMenu(e):"",s=this.render(this.details.message),i=this.attachments,a="",n="",o=l||e&&!v["hide-agents-thumb"]||!e&&v["display-users-thumb"]?`<div class="sb-thumb"><img src="${this.details.profile_image}"><div>${this.details.full_name}</div></div>`:"",r=(e?"":"sb-right")+(""==o?"":" sb-thumb-active"),c="";if(""==s&&0==i.length)return"";if(e){let e=s.match(/\[.+?\]/g)||[],t=!1;for(d=0;d<e.length;d++){let i=N.shortcode(e[d]),a=N.generate(i[1],i[0]);0!=a&&("["!=s.charAt(0)&&(a=a.replace("sb-rich-message","sb-rich-message sb-margin-top")),"]"!=s.charAt(s.length-1)&&(a=a.replace("sb-rich-message","sb-rich-message sb-margin-bottom")),s=s.replace(e[d],a),t=!0,c=`data-type="${i[0]}"`)}t&&(r+=" sb-rich-cnt",e.length>1&&(c='data-type="multiple"'))}if(i.length){a='<div class="sb-message-attachments">';for(var d=0;d<i.length;d++)/.jpg|.jpeg|.png|.gif/.test(i[d][1])?n+=`<div class="sb-image"><img src="${i[d][1]}" /></div>`:a+=`<a rel="noopener" target="_blank" href="${i[d][1]}">${i[d][0]}</a>`;a+="</div>"}return`<div data-id="${this.details.id}" class="${r}" ${c}>${o}<div class="sb-cnt"><div class="sb-message${""!=n&&""==s?" sb-message-media":""}">${s}${n}</div>${a}<div class="sb-time">${E.beautifyTime(this.details.creation_time,!0)}</div></div>${t}</div>`}render(t=!1){let s=t.length;!1===t&&(t=""+this.details.message);let i=t.match(/```([\s\S]*)```/)||[];for(a=0;a<i.length;a++)t=t.replace(i[a],"[code-"+a+"]");t=(t=(t=(t=(t=(t=t.replace(/(?:\r\n|\r|\n)/g,"<br>")).replace(/\*([^\**]+)\*/g,"<b>$1</b>")).replace(/\__([^\____]+)\__/g,"<i>$1</i>")).replace(/\~([^\~~]+)\~/g,"<del>$1</del>")).replace(/\`([^\``]+)\`/g,"<code>$1</code>")).replace(/u([0-9a-f]{4,5})/im,"&#x$1;"),((6==s||5==s)&&t.startsWith("&#x")||s<3&&t.match(/(?:[\u2700-\u27bf]|(?:\ud83c[\udde6-\uddff]){2}|[\ud800-\udbff][\udc00-\udfff]|[\u0023-\u0039]\ufe0f?\u20e3|\u3299|\u3297|\u303d|\u3030|\u24c2|\ud83c[\udd70-\udd71]|\ud83c[\udd7e-\udd7f]|\ud83c\udd8e|\ud83c[\udd91-\udd9a]|\ud83c[\udde6-\uddff]|\ud83c[\ude01-\ude02]|\ud83c\ude1a|\ud83c\ude2f|\ud83c[\ude32-\ude3a]|\ud83c[\ude50-\ude51]|\u203c|\u2049|[\u25aa-\u25ab]|\u25b6|\u25c0|[\u25fb-\u25fe]|\u00a9|\u00ae|\u2122|\u2139|\ud83c\udc04|[\u2600-\u26FF]|\u2b05|\u2b06|\u2b07|\u2b1b|\u2b1c|\u2b50|\u2b55|\u231a|\u231b|\u2328|\u23cf|[\u23e9-\u23f3]|[\u23f8-\u23fa]|\ud83c\udccf|\u2934|\u2935|[\u2190-\u21ff])/))&&(t=`<span class="emoji-large">${t}</span>`),t.indexOf("http")>-1&&(t=t.autoLink({target:"_blank"}));for(var a=0;a<i.length;a++)t=t.replace("[code-"+a+"]","<pre>"+e.trim(e.trim(i[a]).substr(3,i[a].length-6).replace(/(?:\r\n|\r|\n)/g,"<br>")))+"</pre>";return t}}window.SBMessage=L;class I{constructor(e,t){this.details=E.null(t)?{}:t,Array.isArray(e)?(this.messages=[],e.length&&(e[0]instanceof L?this.messages=e:E.error("Messages not of type SBMessage","SBConversation.constructor"))):E.error("Message array not of type Array","SBConversation.constructor")}get id(){return""==this.get("id")?this.get("conversation_id"):this.get("id")}get(e){if(e in this.details&&!E.null(this.details[e]))return this.details[e];if("title"==e){if(!E.null(this.details.first_name))return this.details.first_name+" "+this.details.last_name;if(this.messages.length)return this.messages[0].get("full_name")}return""}set(e,t){this.details[e]=t}getMessage(e){for(var t=0;t<this.messages.length;t++)if(this.messages[t].id==e)return this.messages[t];return!1}getLastMessage(){let e=this.messages.length;return e>0&&this.messages[e-1]}getLastUserMessage(e=!1){!1===e&&(e=this.messages.length-1);for(var t=e;t>-1;t--)if(!E.isAgent(this.messages[t].get("user_type")))return this.messages[t];return!1}updateMessage(e,t){if(t instanceof L){for(var s=0;s<this.messages.length;s++)if(this.messages[s].id==e)return this.messages[s]=t,!0}else E.error("Message not of type SBMessage","SBConversation.updateMessage");return!1}addMessages(e){if(Array.isArray(e))for(var t=0;t<e.length;t++)e[t]instanceof L&&this.messages.push(e[t]);else e instanceof L?this.messages.push(e):E.error("Messages not of type SBMessage","SBConversation.addMessages()")}getCode(){let e=this.messages.length;if(e){let t=this.messages[e-1],s=t.get("message");if(!1!==s.indexOf("[")){let e=s.match(/\[.+?\]/g)||[];if(e.length){let t=N.shortcode(e[0]);s=s.replace(e[0],i(E.null(t[1].message)?E.null(t[1].title)?"":t[1].title:t[1].message))}}let a=y&&!v["tickets-conversations-title-user"]?this.get("title"):i(l||"#"!=t.get("last_name").charAt(0)?t.get("full_name"):"You");return`<div class="sb-conversation-item" data-user-id="${t.get("user_id")}"><img src="${t.get("profile_image")}"><div><span class="sb-name">${a}</span><span class="sb-time">${E.beautifyTime(t.get("creation_time"))}</span></div><div class="sb-message">${s.length>114?s.substr(0,114)+" ...":s}</div></div>`}return""}deleteMessage(e){for(var t=0;t<this.messages.length;t++)if(this.messages[t].id==e)return this.messages.splice(t,1),!0;return!1}searchMessages(e,t=!1){let s=[];for(var i=0;i<this.messages.length;i++){let a=this.messages[i].get("message");(t&&a==e||!t&&a.indexOf(e)>-1)&&s.push[messages[i]]}return s}getAttachments(){let e=[];for(var t=0;t<this.messages.length;t++){let i=this.messages[t].attachments;for(var s=0;s<i.length;s++){let a=i[s][1];e.push([i[s][0],a,a.substr(a.lastIndexOf(".")+1),this.messages[t].id])}}return e}}window.SBConversation=I;var D={rich_messages_list:["chips","buttons","select","inputs","table","list"],emoji_options:{range:0,range_limit:47,list:[],list_now:[],touch:!1},initialized:!1,editor_listening:!1,conversation:!1,is_busy:!1,is_busy_update:!1,chat_open:!1,real_time:!1,agent_id:-1,agent_online:!1,user_online:!1,expanded:!1,main_header:!0,start_header:!1,desktop_notifications:!1,flash_notifications:!1,datetime_last_message:"2000-01-01 00:00:00",datetime_last_message_conversation:"2000-01-01 00:00:00",audio:!1,audio_out:!1,tab_active:!0,notifications:[],typing_settings:{typing:!1,sent:!1,timeout:!1},email_sent:!1,dialogflow_token:0==s("dialogflow-token")?-1:s("dialogflow-token"),dashboard:!1,articles:!1,slack_channel:[-1,-1],skip:!1,queue_interval:!1,departments:!1,default_department:null,sendMessage:function(t=-1,s="",n=[],o=!1,r=!1,c=!1){let g=(w||0!=_)&&R.dialogflow.active(),m=g&&R.dialogflow.active()?0:2,f=!!this.conversation&&this.conversation.getLastMessage();if(c=!1===c?f?l?1:m:l?1:-1:c,0==this.conversation){let e=!l&&a().getLastConversation();if(!e||"new-conversation"==x)return this.newConversation(c,t,"",[],l&&""!=SB_ACTIVE_AGENT.department?SB_ACTIVE_AGENT.department:null,null,()=>this.sendMessage(t,s,n,o,r)),!1;this.openConversation(e.id),this.setConversation(e),x=!1}if(-1==t&&(t=l?SB_ACTIVE_AGENT.id:a().id),""==s&&(s=e(h).val().trim()),0==n.length&&e(u).find(".sb-attachments > div").each(function(){n.push([e(this).attr("data-name"),e(this).attr("data-value")])}),""!=s||n.length||r){let m=t!=b;this.busy(!0),e(h).val("").css("height",""),e(u).find(".sb-attachments").html(""),this.activateBar(!1),E.ajax({function:"send-message",user_id:t,conversation_id:this.conversation.id,message:s,attachments:n,conversation_status_code:c,queue:!l&&v.queue&&m,payload:r},e=>{let i=0!=this.conversation,d=l||!g;(l&&!this.user_online||!l&&!this.agent_online)&&this.update(),!l&&this.dashboard&&t==b&&this.updateConversations(),!l&&m&&v.follow&&this.followUp(),!m||g&&E.null(r["skip-dialogflow"])||!(!l&&v["notify-agent-email"]||l&&!this.user_online&&v["notify-user-email"]&&""!=a().get("email"))||this.sendEmail(s,n),l||!m||g||!v["push-notifications"]||A&&this.agent_online||this.pushNotification(s),m&&(!r||"sb-human-takeover"!=r.id&&E.null(r["skip-dialogflow"]))&&this.sendBotMessage(s,n),!l&&m&&"visitor"==a().type?E.ajax({function:"update-user-to-lead",user_id:t},()=>{a().set("user_type","lead"),v["slack-active"]&&d&&this.slackMessage(t,a().name,a().image,s,n)}):v["slack-active"]&&d&&!this.skip&&(l?this.slackMessage(a().id,SB_ACTIVE_AGENT.full_name,SB_ACTIVE_AGENT.profile_image,s,n):this.slackMessage(a().id,m?a().name:v["bot-name"],m?a().image:v["bot-image"],s,n)),!m||l||!v.timetable||v["office-hours"]&&A||!E.storageTime("timetable",1)||setTimeout(()=>{i&&(this.sendMessage(b,v["timetable-hide"]?v["timetable-message"]:"[timetable]"),this.scrollBottom(),E.storageTime("timetable"))},5e3),!this.articles||l||!v.articles||v["office-hours"]||this.isInitDashboard()||setTimeout(()=>{i&&(this.sendMessage(b,"[articles]"),this.scrollBottom(),this.articles=!1)},5e3),e.queue&&this.queue(this.conversation.id);let u={user_id:t,conversation_id:this.conversation.id,conversation_status_code:c,message_id:e["message-id"],message:s,attachments:n};E.event("SBMessageSent",u),!1!==o&&o(u),this.skip&&(this.skip=!1),this.busy(!1)}),m&&(s=E.escape(s),e(d).append(new L({id:"sending",profile_image:l?SB_ACTIVE_AGENT.profile_image:a().image,full_name:a().name,creation_time:"0000-00-00 00:00:00",message:s,user_type:l?"agent":"user"}).getCode().replace('<div class="sb-time"></div>',`<div class="sb-time">${i("Sending")}<i></i></div>`)),this.dashboard||this.scrollBottom()),(!l&&this.chat_open&&m&&["a","aa"].includes(v["chat-sound"])||l&&"a"==SB_ADMIN_SETTINGS.sounds)&&this.audio_out.play()}},sendBotMessage:function(e="",t=[]){R.dialogflow.active()&&(k=setTimeout(()=>{this.typing(-1,"start"),setTimeout(()=>{this.typing(-1,"stop")},1e4)},1e3),setTimeout(()=>{E.ajax({function:"send-bot-message",conversation_id:this.conversation.id,message:e,attachments:t,token:this.dialogflow_token},t=>{if(!E.errorValidation(t)){let n=!E.null(t.response.queryResult)&&"input.unknown"==t.response.queryResult.action,o=!1,r="messages"in t&&Array.isArray(t.messages)?t.messages:[];if(this.typing(-1,"stop"),clearTimeout(k),this.dialogflow_token!=t.token&&(this.dialogflow_token=t.token,s("dialogflow-token",t.token)),n&&(w||v["dialogflow-disable"])&&R.dialogflow.active(!1),n&&0!=_&&E.storageTime("human-takeover",1)&&setTimeout(()=>{this.sendMessage(b,`[chips id="sb-human-takeover" options="${_.confirm},${_.cancel}" message="${_.message.replace(/"/g,"")}"]`)},1100),"queryResult"in t.response){let e=t.response.queryResult;if("action"in e){let t=e.action;"end"==t&&R.dialogflow.active(!1),E.event("SBBotAction",t)}for(i=0;i<r.length;i++)if("payload"in r[i]){let e=["human-takeover","redirect","woocommerce-update-cart","woocommerce-checkout","open-article"],t=r[i].payload;if(E.null(t)&&(t=[]),e[0]in t&&!0===t[e[0]]&&(o=!0,v["dialogflow-disable"]&&R.dialogflow.active(!1)),e[1]in t&&setTimeout(function(){document.location=t[e[1]]},500),e[2]in t){let s=t[e[2]];R.woocommerce.updateCart(s[0],s[1],e=>{e&&E.event("SBWoocommerceCartUpdated",{action:s[0],product:s[1]})})}e[3]in t&&!0===t[e[3]]&&R.wordpress.ajax("url",{url_name:"checkout"},e=>{setTimeout(function(){document.location=e},500)}),e[4]in t&&D.showArticles(t[e[4]]),E.event("SBBotPayload",t)}if("diagnosticInfo"in e){let t=e.diagnosticInfo;"end_conversation"in t&&t.end_conversation&&R.dialogflow.active(!1)}}if(v["slack-active"]&&r&&(!w||n||o)){if(n||o){let e=this.conversation.getLastUserMessage();this.slackMessage(a().id,a().name,a().image,e.get("message"))}for(var i=0;i<r.length;i++)this.slackMessage(a().id,v["bot-name"],v["bot-image"],r[i].message,r[i].attachments)}(o||!l&&v["notify-agent-email"]&&w&&n)&&R.dialogflow.unknowEmail(e),(o||!l&&v["push-notifications"]&&w&&n)&&this.pushNotification(e),E.event("SBBotMessage",{response:t,message:e})}})},0==v["bot-delay"]?2e3:parseInt(v["bot-delay"])))},updateMessage:function(e,t=""){E.ajax({function:"update-message",message_id:e,message:t})},sendEmail:function(e,t){if(!this.email_sent){let s=l?a().id:0!=this.lastAgent(!1)?this.lastAgent(!1).user_id:-1;if(!l&&-1!=s&&this.agent_online)return!1;E.ajax({function:"create-email",recipient_id:s,sender_name:l?SB_ACTIVE_AGENT.full_name:a().name,sender_profile_image:l?SB_ACTIVE_AGENT.profile_image:a().image,message:e,attachments:t,conversation_id:!!D.conversation&&D.conversation.id},()=>{this.email_sent=!0,E.event("SBEmailSent",{recipient_id:s,message:e,attachments:t})})}},pushNotification:function(e){E.ajax({function:"push-notification",title:l?SB_ACTIVE_AGENT.full_name:a().name,message:e,icon:l?SB_ACTIVE_AGENT.profile_image:a().image.indexOf("user.svg")>0?v["notifications-icon"]:a().image,interests:l?a().id:0!=this.lastAgent(!1)?this.lastAgent(!1).user_id:E.null(this.conversation.get("agent_id"))?"agents":this.conversation.get("agent_id"),conversation_id:0!=this.conversation&&this.conversation.id})},desktopNotification:function(e,t,s,i=!1,n=!1){if("granted"!==Notification.permission)Notification.requestPermission();else{new Notification(e,{body:t,icon:s.indexOf("user.svg")>0?v["notifications-icon"]:s}).onclick=(()=>{l?i&&SBAdmin.conversations.openConversation(i,0==n?a().id:n):this.start(),window.focus()})}},submit:function(){if(!this.is_busy){if(0==a()&&!l)return this.addUserAndLogin(()=>{this.newConversation(2,-1,"",[],null,null,()=>{this.sendMessage()})}),void this.busy(!0);this.sendMessage()}},initChat:function(){E.getActiveUser(!0,()=>{let t=!1!==a(),n=!!t&&a().type;l||y||!v.popup||s("popup")||C&&v["popup-mobile-hidden"]||this.popup(),l||y||!v.privacy||v["registration-required"]||s("privacy-approved")?(typeof Notification!==B&&("all"==v["desktop-notifications"]||!l&&"users"==v["desktop-notifications"]||l&&"agents"==v["desktop-notifications"])&&(this.desktop_notifications=!0),("all"==v["flash-notifications"]||!l&&"users"==v["flash-notifications"]||l&&"agents"==v["flash-notifications"])&&(this.flash_notifications=!0),!this.registration(!0)||y?(t||!(typeof SB_WP_WAITING_LIST!==B||v["visitors-registration"]||v.welcome||v.subscribe||y)||y&&v["tickets-registration-required"]?0==this.conversation&&t?this.populateConversations():this.finalizeInit():this.addUserAndLogin(()=>{this.welcome(),this.subscribe(),R.woocommerce.waitingList(),this.finalizeInit()}),v["header-name"]&&t&&"user"==n&&!y&&e(g).find(".sb-title").html(`${i("Hello")} ${a().name}!`),this.welcome(),this.subscribe(),R.woocommerce.waitingList(),setInterval(()=>{this.updateConversations(),this.updateUsersActivity()},1e4),this.scrollBottom(!0)):this.registration()):this.privacy()})},finalizeInit:function(){this.initialized||(e(n).attr("style",""),0!=a()&&E.ajax({function:"current-url",url:window.location.href}),l||y||(this.isInitDashboard()&&this.showDashboard(),!C&&window.innerHeight<760&&e(n).find(" > .sb-body").css("max-height",window.innerHeight-130+"px")),this.initialized=!0,l||(s("open-conversation")&&!1!==a()&&!this.registration(!0)&&this.openConversation(s("open-conversation")),!this.chat_open&&s("chat-open")&&setTimeout(()=>{this.start()},500),v["woocommerce-returning-visitor"]&&(!1===s("returning-visitor")?E.storageTime("returning-visitor"):E.storageTime("returning-visitor",24)&&!s("returning-visitor-processed")&&setTimeout(()=>{E.ajax({function:"woocommerce-returning-visitor"},()=>{s("returning-visitor-processed",!0)})},15e3))),E.event("SBInit"))},start:function(){this.initialized&&(this.populate(),this.headerAgent(),this.updateUsersActivity(),this.startRealTime(),this.chat_open=!0,this.popup(!0),0!=this.conversation&&this.updateNotifications("remove",this.conversation.id),e(n).sbActivate(),e("body").addClass("sb-chat-open"),"open"==v["welcome-trigger"]&&this.welcome())},open:function(t=!0){t&&!this.chat_open?(this.start(),this.chat_open=!0,this.startRealTime(),e(n).sbActivate(),e("body").addClass("sb-chat-open"),s("chat-open",!0),E.event("SBChatOpen")):!t&&this.chat_open&&(e(n).sbActivate(!1),this.stopRealTime(),this.chat_open=!1,s("chat-open",!1),e("body").removeClass("sb-chat-open"),E.event("SBChatClose"))},openConversation:function(e){a().getFullConversation(e,t=>{if(""==t.id)return s("open-conversation",""),!1;this.setConversation(t),this.hideDashboard(),this.populate(),this.main_header=!1,(this.chat_open||y)&&0!=t.get("conversation_status_code")&&this.updateNotifications("remove",e),s("open-conversation",e),E.event("SBConversationOpen",t)})},update:function(){if(0!=this.conversation&&!this.is_busy_update){let t=this.conversation.getLastMessage(),s=!1;E.ajax({function:"get-new-messages",conversation_id:this.conversation.id,datetime:this.datetime_last_message_conversation},i=>{let n=i.length;if(this.is_busy_update=!1,0!=this.conversation&&Array.isArray(i)&&n>0&&(!t||t.id!=i[n-1].id||t.get("message")!=i[n-1].message)){let t="",r=[],c=[];for(var o=0;o<n;o++)if(!c.includes(i[o].id)){let n=new L(i[o]),u=n.payload();if(this.datetime_last_message_conversation=n.get("creation_time"),"boolean"!=typeof u&&"event"in u){let e=u.event;("delete-message"==e&&!1!==this.conversation.getMessage(n.id)||!l&&""==n.get("message")&&!n.attachments.length)&&this.deleteMessage(n.id),"chips-click"==e&&"sb-human-takeover"==u.id&&_.confirm==u.result&&(v["dialogflow-disable"]&&R.dialogflow.active(!1),R.dialogflow.unknowEmail(this.conversation.getLastUserMessage().get("message")),this.setConversationStatus(2),E.storageTime("human-takeover"),setTimeout(()=>{_.email&&E.null(a().get("email"))?this.sendMessage(b,`[email id="sb-human-takeover-email" message="${_["email-message"]}" placeholder="${v.follow.placeholder}" name="${v.follow.name}" last-name="${v.follow["last-name"]}" success="${_.success}"]`):""!=_["message-confirmation"]&&this.sendMessage(b,_.success)},1100)),"woocommerce-update-cart"!=e||l||R.woocommerce.updateCart(u.action,u.id)}0==this.conversation.getMessage(i[o].id)?(this.conversation.addMessages(n),t+=n.getCode()):(this.conversation.updateMessage(n.id,n),e(d).find(`[data-id="${n.id}"]`).replaceWith(n.getCode()),s=!0),r.push(n),c.push(n.id)}e(d).append(t);let u=this.conversation.getLastMessage(),h=u.get("user_type");!l&&this.chat_open&&E.isAgent(h)&&"bot"!=h&&(-1==u.get("message").indexOf("sb-rich-success")&&this.setConversationStatus(0),v.follow&&clearTimeout(k),R.dialogflow.active(!1)),e(d).find('[data-id="sending"]').remove(),this.headerAgent(),this.dashboard||s||(this.scrollBottom(),setTimeout(()=>{this.scrollBottom()},300)),this.typing(-1,"stop"),(!l&&this.chat_open&&(E.isAgent(h)||"bot"==h)&&["aa","ia"].includes(v["chat-sound"])||l&&!E.isAgent(h)&&["a","i","ic"].includes(SB_ADMIN_SETTINGS.sounds))&&this.audio.play(),E.event("SBNewMessagesReceived",r)}}),this.is_busy_update=!0}},updateConversations:function(){0!=a()&&E.ajax({function:"get-new-user-conversations",datetime:this.datetime_last_message},t=>{if(t.length){this.datetime_last_message=t[0].creation_time;for(var s=0;s<t.length;s++){let e=t[s].conversation_id,n=new L(t[s]),o=t[s].conversation_status_code,r=new I([n],{id:e,conversation_status_code:o,department:t[s].department,title:t[s].title}),l=a().addConversation(r);0==this.conversation&&(this.conversation=r),t[s].user_id==a().id||this.conversation.id==e&&this.chat_open||(this.updateNotifications("add",e),v["auto-open"]&&this.start());let c=n.payload();if("boolean"!=typeof c&&"event"in c){if("open-chat"==c.event&&((this.conversation.id!=e||this.dashboard)&&this.openConversation(e),setTimeout(()=>{this.open()},500)),""==n.get("message")&&!n.attachments.length)continue}this.tab_active||(this.desktop_notifications&&D.desktopNotification(n.get("full_name"),n.get("message"),n.get("profile_image")),this.flash_notifications&&(document.title=i("New message..."))),l&&E.event("SBNewConversationReceived",r)}!["a","aa","i"].includes(v["chat-sound"])||this.chat_open&&this.tab_active&&!this.dashboard||this.audio.play(),e(n).find(".sb-user-conversations").html(a().getConversationsCode())}})},populate:function(){if(0!=this.conversation){let s="",i=e(d).find(" > .sb-notify-message");for(var t=0;t<this.conversation.messages.length;t++)s+=this.conversation.messages[t].getCode();e(d).html((i.length?e(i)[0].outerHTML:"")+s),this.dashboard||this.scrollBottom()}else 0==a()||a().isConversationsEmpty()||this.showDashboard()},populateConversations:function(t=!1){0!=a()&&a().getConversations(i=>{let o=i.length;if(o){this.datetime_last_message=i[0].messages[0].get("creation_time");for(var r=0;r<o;r++)1==i[r].get("conversation_status_code")&&this.updateNotifications("add",i[r].id);e(n).removeClass("sb-no-conversations"),e(n).find(".sb-user-conversations").html(a().getConversationsCode())}this.initialized&&"open-conversation"!=x||1!=o||this.isInitDashboard()||s("open-conversation")||(this.openConversation(a().conversations[0].id),"open-conversation"==x&&(x="")),!1!==t&&t(i),this.finalizeInit()})},newConversation:function(t,s=-1,i="",o=[],r=null,l=null,c=!1){0!=a()?E.ajax({function:"new-conversation",status_code:t,title:y?e(n).find(".sb-ticket-title input").val():null,department:E.null(r)?this.default_department:r,agent_id:l,routing:v.routing},e=>{if(E.errorValidation(e,"user-not-found"))return void this.addUserAndLogin(()=>{this.newConversation(t,s,i,o,r,l,c)});let a=new I([],e.details);this.setConversation(a),(""!=i||o.length>0)&&this.sendMessage(s,i,o,!1,!!y&&{"skip-dialogflow":!0}),s!=b&&this.queue(a.id),!1!==c&&c(a),E.event("SBNewConversationCreated",a)}):E.error("activeUser() not setted","SBChat.newConversation")},setConversation:function(e){e instanceof I?(this.conversation=e,this.datetime_last_message_conversation=0==this.conversation.getLastMessage()?"2000-01-01 00:00:00":this.conversation.getLastMessage().get("creation_time"),e.id!=this.conversation.id&&this.queue(e.id),s("open-conversation",e.id),E.event("SBActiveConversationChanged",e)):E.error("Value not of type SBConversation","SBChat.setConversation")},queue:function(t){!l&&v.queue&&E.ajax({function:"queue",conversation_id:t,department:this.conversation.get("department")},a=>{if(e(d).find(" > .sb-notify-message").remove(),0==a)this.sendMessage(b,i(""==v["queue-message-success"]?"It's your turn! An agent will reply to you shortly.":v["queue-message-success"])),e(n).removeClass("sb-notify-active"),clearInterval(this.queue_interval),this.queue_interval=!1,s("queue","");else{let o=(""==v["queue-response-time"]?5:parseInt(v["queue-response-time"]))*a,r=i(""==v["queue-message"]?"Please wait for an agent. You are number {position} in the queue. Your waiting time is approximately {minutes} minutes.":v["queue-message"]).replace("{position}","<b>"+a+"</b>").replace("{minutes}","<b>"+o+"</b>");e(d).prepend(`<div class="sb-notify-message sb-rich-cnt"><div class="sb-cnt"><div class="sb-message">${r}</div></div></div>`),!1===this.queue_interval&&(this.queue_interval=setInterval(()=>{this.queue(t)},1e4),e(n).addClass("sb-notify-active"),s("queue",t))}E.event("SBQueueUpdate",a)})},getDepartmentCode(e,t){if(0!=this.departments)if("all"==e){let e="";for(var s in this.departments)this.getDepartmentCode(this.departments[s].id,t=>{e+=t});t(e)}else t(`<div data-color="${this.departments[e].color}">${""==this.departments[e].image?"<span></span>":`<img src="${this.departments[e].image}" />`}<div>${this.departments[e].name}<div></div>`);else E.ajax({function:"get-departments"},s=>{0!=s&&(this.departments=s,this.getDepartmentCode(e,t))})},startRealTime:function(){this.stopRealTime(),this.real_time=setInterval(()=>{(!l||l&&this.user_online)&&this.update(),this.typing(l?0!=a()?a().id:-1:this.agent_id,"check")},1e3)},stopRealTime:function(){clearInterval(this.real_time)},updateUsersActivity:function(){0!=a()&&E.updateUsersActivity(a().id,this.agent_id,t=>{this.typing_settings.typing||("online"==t||this.agent_id==b?(e(m).addClass("sb-status-online").html(i("Online")),this.agent_online=!0):(e(m).removeClass("sb-status-online").html(i("Away")),this.agent_online=!1))})},busy:function(t){e(u).find(".sb-loader").sbActivate(t),this.is_busy=t,E.event("SBBusy",t)},headerAgent:function(){if(!l&&!y&&!this.dashboard&&0!=this.conversation&&(-1==this.agent_id||0!=this.conversation.getLastMessage()&&E.isAgent(this.conversation.getLastMessage().get("user_type"))&&this.conversation.getLastMessage().get("user_id")!=this.agent_id)){let t=this.lastAgent();0!=t&&(this.agent_id=t.user_id,this.headerReset(),e(g).addClass("sb-header-agent").attr("data-agent-id",this.agent_id).html(`<div class="sb-dashboard-btn sb-icon-arrow-left"></div><div class="sb-profile"><img src="${t.profile_image}" /><div><span class="sb-name">${t.full_name}</span><span class="sb-status">${i("Away")}</span></div></div>`),m=e(g).find(".sb-status"),this.updateUsersActivity())}},headerReset:function(){0==this.start_header&&(this.start_header=[e(g).html(),e(g).attr("class")]),e(g).removeClass("sb-header-main sb-header-brand sb-header-agent"),this.main_header=!1},lastAgent:function(e=!0){let t=!1;if(0!=this.conversation)for(var s=this.conversation.messages.length-1;s>-1;s--){let i=this.conversation.messages[s].get("user_type");if(E.isAgent(i)&&(e||!e&&"bot"!=i)){t={user_id:this.conversation.messages[s].get("user_id"),full_name:this.conversation.messages[s].get("full_name"),profile_image:this.conversation.messages[s].get("profile_image")};break}}return t},scrollBottom:function(t=!1){setTimeout(()=>{e(p).scrollTop(t?0:e(p)[0].scrollHeight),this.scrollHeader()},20)},scrollHeader:function(){if(this.main_header&&this.dashboard){let t=e(p).scrollTop();t>-1&&t<1e3&&e(g).find(".sb-content").css({opacity:1-t/500,top:t/10*-1+"px"})}},showDashboard:function(){l||y||(e(n).addClass("sb-dashboard-active"),e(g).removeClass("sb-header-agent"),this.hidePanel(),0!=this.start_header&&e(g).html(this.start_header[0]).addClass(this.start_header[1]),e(p).find(" > div").sbActivate(!1),e(n).find(".sb-dashboard").sbActivate(),this.populateConversations(),this.conversation=!1,this.agent_id=-1,this.stopRealTime(),this.dashboard=!0,this.main_header=!0,this.scrollBottom(!0),E.event("SBDashboard"))},hideDashboard:function(){l||y||(e(d).sbActivate(),e(n).removeClass("sb-dashboard-active").find(".sb-dashboard").sbActivate(!1),this.dashboard=!1,this.headerAgent(),this.scrollHeader(0),this.chat_open&&this.startRealTime(),E.event("SBDashboardClosed"))},showPanel:function(t,s){if(y)return SBTickets.showPanel(t,s);let a=e(p).find(" > .sb-panel-"+t);a.length&&(e(p).find(" > div").sbActivate(!1),e(a).sbActivate(),0==this.start_header&&(this.start_header=[e(g).html(),e(g).attr("class")]),e(g).attr("class","sb-header sb-header-panel").html(`${i(s)}<div class="sb-dashboard-btn sb-icon-close"></div>`),e(n).addClass("sb-panel-active"),this.dashboard=!0),E.event("SBPanelActive",t)},hidePanel:function(){e(n).removeClass("sb-panel-active"),e(g).removeClass("sb-header-panel")},clear:function(){this.conversation=!1,e(d).html("")},updateNotifications:function(t="add",s){if("add"!=t||this.notifications.includes(s)||this.notifications.push(s),"remove"==t)for(var i=0;i<this.notifications.length;i++)if(this.notifications[i]==s){this.notifications.splice(i,1),["1","2",1,2].includes(this.conversation.get("conversation_status_code"))&&this.setConversationStatus(0);break}let a=this.notifications.length;e(n).find(".sb-chat-btn span").attr("data-count",a).html(a>-1?a:0),E.event("SBNotificationsUpdate",{action:t,conversation_id:s})},setConversationStatus:function(e){return 0!=this.conversation&&(E.ajax({function:"update-conversation-status",conversation_id:this.conversation.id,status_code:e},()=>{this.conversation.set("conversation_status_code",e),E.event("SBActiveConversationStatusUpdated",{conversation_id:this.conversation.id,status_code:e})}),!0)},typing:function(t=-1,s="check"){if(0!=this.conversation)if("check"==s&&-1!=t&&t!=b&&(this.agent_online||l&&this.user_online))E.ajax({function:"is-typing",user_id:t,conversation_id:this.conversation.id},e=>{e&&!this.typing_settings.typing?this.typing(-1,"start"):!e&&this.typing_settings.typing&&this.typing(-1,"stop")});else if("set"==s)this.typing_settings.sent?(clearTimeout(this.typing_settings.timeout),this.typing_settings.timeout=setTimeout(()=>{E.ajax({function:"set-typing",user_id:t,conversation_id:-1},()=>{this.typing_settings.sent=!1})},2e3)):(this.typing_settings.sent=!0,E.ajax({function:"set-typing",user_id:t,conversation_id:this.conversation.id}),this.typing(t,"set"));else if("start"==s||"stop"==s){let t="start"==s;l||(t?e(m).addClass("sb-status-typing").html(i("Typing")):e(m).removeClass("sb-status-typing").addClass("sb-status-online").html(i("Online"))),this.typing_settings.typing=t,E.event("SBTyping",t)}},showArticles:function(t=-1){let s=y?e(n).find(".sb-panel-main .sb-panel"):e(p).find(" > .sb-panel-articles"),a="";e(s).html("").sbLoading(!0),this.showPanel("articles",""==v["articles-title"]?"Help Center":v["articles-title"]),this.getArticles(t,n=>{if(-1==t){for(var o=0;o<n.length;o++)a+=`<div data-id="${n[o].id}"><div>${n[o].title}</div><span>${n[o].content}</span></div>`;e(s).html(`<div class="sb-articles">${a}</div>`)}else!1!==n&&e(s).html(`<div data-id="${n.id}" class="sb-article"><div class="sb-title">${n.title}</div><div class="sb-content">${n.content.replace(/(?:\r\n|\r|\n)/g,"<br>")}</div>${""==n.link?"":`<a href="${n.link}" target="_blank" class="sb-btn-text"><i class="sb-icon-plane"></i>${i("Read more")}</a>`}</div>`);e(s).sbLoading(!1),E.event("SBArticles",{id:t,articles:n})})},getArticles:function(e=-1,t=!1){if(!1===this.articles||-1!=e)E.ajax({function:"get-articles",id:e},s=>{if(-1==e&&(this.articles=s),!1===t)return s;t(s)});else{if(!1===t)return this.articles;t(this.articles)}},searchArticles:function(t,s){""!=t&&(e(s).sbLoading(!0),E.ajax({function:"search-articles",search:t},t=>{let a="";if(0==t.length)a+=`<p class="sb-no-results">${i("No articles found.")}</p>`;else for(var o=0;o<t.length;o++)a+=`<div data-id="${t[o].id}"><div>${t[o].title}</div><span>${t[o].content}</span></div>`;e(n).find(".sb-dashboard-articles .sb-articles").html(a),e(s).sbLoading(!1)}))},categoryEmoji:function(e){let t=this.emoji_options.list;if("all"==e)this.emoji_options.list_now=t;else{this.emoji_options.list_now=[];for(var s=0;s<t.length;s++)t[s].category.startsWith(e)&&this.emoji_options.list_now.push(t[s])}this.emoji_options.range=0,this.populateEmoji(0),this.populateEmojiBar()},mouseWheelEmoji:function(t){let s=this.emoji_options.range;(function(e){let t=e.originalEvent.wheelDelta;return typeof t==B&&(t=e.originalEvent.deltaY),typeof t==B&&(t=-1*e.originalEvent.detail),t})(t)>0||C&&typeof t.originalEvent.changedTouches!==B&&this.emoji_options.touch<t.originalEvent.changedTouches[0].clientY?s-=s<1?0:1:s+=s>this.emoji_options.range_limit?0:1,e(f).find(".sb-emoji-bar > div").sbActivate(!1).eq(s).sbActivate(),this.emoji_options.range=s,this.populateEmoji(s),t.preventDefault()},insertEmoji:function(t){t.indexOf(".svg")>0&&(t=e.parseHTML(t)[0].alt),this.insertText(t),e(f).sbTogglePopup()},showEmoji:function(t){e(f).sbTogglePopup(t)&&(l||e(f).css({left:e(u).offset().left+(y?68:20),top:e(u).offset().top-window.scrollY-(y?e(u).height()-330:304)}),""==e(f).find(".sb-emoji-list > ul").html()&&jQuery.ajax({method:"POST",url:SB_AJAX_URL,data:{function:"emoji"}}).done(e=>{this.emoji_options.list=JSON.parse(e),this.emoji_options.list_now=this.emoji_options.list,this.populateEmoji(0),this.populateEmojiBar()}),E.deselectAll())},populateEmoji:function(t){let s="",i=C?42:48,a=t*i+i,n=this.emoji_options.list_now;a>n.length&&(a=n.length),this.emoji_options.range_limit=n.length/i-1,this.emoji_options.range=t;for(var o=t*i;o<a;o++)s+=`<li>${n[o].char}</li>`;e(f).find(".sb-emoji-list").html(`<ul>${s}</ul>`)},populateEmojiBar:function(){let t='<div class="sb-active"></div>',s=C?42:49;for(var i=0;i<this.emoji_options.list_now.length/s-1;i++)t+="<div></div>";this.emoji_options.range=0,e(f).find(".sb-emoji-bar").html(t)},clickEmojiBar:function(t){let s=e(t).index();this.populateEmoji(s),this.emoji_options.range=s,e(f).find(".sb-emoji-bar > div").sbActivate(!1).eq(s).sbActivate()},searchEmoji:function(e){E.search(e,()=>{if(e.length>1){let s=this.emoji_options.list,i=[];for(var t=0;t<s.length;t++)(s[t].category.toLowerCase().indexOf(e)>-1||s[t].name.toLowerCase().indexOf(e)>-1)&&i.push(s[t]);this.emoji_options.list_now=i}else this.emoji_options.list_now=this.emoji_options.list;this.emoji_options.range=0,this.populateEmoji(0),this.populateEmojiBar()})},textareaChange:function(t){let s=e(t).val();l&&SBAdmin.conversations.savedReplies(t,s),""!=s?(this.typing(l?SB_ACTIVE_AGENT.id:a().id,"set"),this.activateBar()):this.activateBar(!1)},insertText:function(t){let s=e(h).get(0),i=0;if(this.dashboard)return!1;if("selectionStart"in s)i=s.selectionStart;else if("selection"in document){s.focus();let e=document.selection.createRange();var a=document.selection.createRange().text.length;e.moveStart("character",-s.value.length),i=e.text.length-a}e(s).val(e(s).val().substr(0,i)+t+e(s).val().substr(i)),e(s).focus(),e(s).manualExpandTextarea(),this.activateBar()},enabledAutoExpand:function(){h.length&&e(h).autoExpandTextarea()},privacy:function(){E.ajax({function:"get-block-setting",value:"privacy"},t=>{e(p).append(`<div class="sb-privacy sb-init-form" data-decline="${t.decline}"><div class="sb-title">${t.title}</div><div class="sb-text">${t.message}</div>`+(""!=t.link?`<a target="_blank" href="${t.link}">${t["link-name"]}</a>`:"")+`<div class="sb-buttons"><a class="sb-btn sb-approve">${t["btn-approve"]}</a><a class="sb-btn sb-decline">${t["btn-decline"]}</a></div></div>`),this.finalizeInit(),E.event("SBPrivacy")}),this.dashboard||this.showDashboard(),this.dashboard=!0,e(n).addClass("sb-init-form-active")},popup:function(t=!1,i=!1){let a=e(n).find(".sb-popup-message");a.length&&e(a).remove(),t?s("popup",!0):this.chat_open||(0==i?E.ajax({function:"get-block-setting",value:"popup"},e=>{setTimeout(()=>{this.chat_open||this.popup(t,e)},1e3)}):(e(n).append('<div class="sb-popup-message">'+("image"in i&&""!=i.image?`<img src="${i.image}" />`:"")+("title"in i&&""!=i.title?`<div class="sb-top">${i.title}</div>`:"")+`<div class="sb-text">${i.message}</div><div class="sb-icon-close"></div></div>`),E.event("SBPopup",i)))},followUp:function(){this.followUpCheck()&&(0!=k&&clearTimeout(k),k=setTimeout(()=>{if(this.followUpCheck()){let e=v.follow;this.sendMessage(b,`[email title="${e.title}" message="${e.message}" placeholder="${e.placeholder}" name="${e.name}" last-name="${e["last-name"]}" success="${e.success}"]`),this.scrollBottom(),E.storageTime("email"),E.event("SBFollowUp")}},E.null(v.follow["follow-delay"])?v["office-hours"]||A?15e3:R.dialogflow.active()?8e3:5e3:parseInt(v["follow-delay"])))},followUpCheck:function(){return!l&&0!=this.conversation&&0!=a()&&""==a().get("email")&&E.storageTime("email",24)},welcome:function(){("open"!=v["welcome-trigger"]||this.chat_open)&&v.welcome&&!s("welcome")&&a()&&E.ajax({function:"get-block-setting",value:"welcome"},e=>{setTimeout(()=>{v["dialogflow-welcome"]?!1===this.conversation?this.newConversation(3,-1,"",[],null,null,function(){R.dialogflow.welcome()}):R.dialogflow.welcome():this.sendMessage(b,e.message,[],!1,!1,3),e.open&&this.start(),e.sound&&this.audio.play(),this.skip=!0,E.event("SBWelcomeMessage")},parseInt(v["welcome-delay"])),s("welcome",!0)})},subscribe:function(){v.subscribe&&!s("subscribe")&&0!=a()&&E.null(a().get("email"))&&a()&&setTimeout(()=>{E.ajax({function:"get-block-setting",value:"subscribe"},e=>{this.sendMessage(b,e.message,[],!1,{event:"open-chat"},-1),e.sound&&this.audio.play(),this.skip=!0,s("subscribe",!0)})},parseInt(v["subscribe-delay"]))},slackMessage:function(e,t,s,i,n=[]){if(0==this.conversation)return!1;let o=this.conversation.id;E.ajax({function:"send-slack-message",user_id:e,full_name:t,profile_image:s,conversation_id:o,message:i,attachments:n,channel:this.slack_channel[0]==a().id?this.slack_channel[1]:-1},e=>{this.slack_channel=[a().id,e[1]],E.event("SBSlackMessageSent",{message:i,conversation_id:o,slack_channel:e[1]})})},deleteMessage:function(t){E.ajax({function:"delete-message",message_id:t},()=>{this.conversation.deleteMessage(t),e(d).find(`[data-id="${t}"]`).remove(),E.event("SBMessageDeleted",t)})},registration:function(t=!1,s=v["registration-required"]){if(t)return""!=v["registration-required"]&&(!v["registration-offline"]||!A)&&(!v["registration-timetable"]||!v["office-hours"])&&(!1===a()||["visitor","lead"].includes(a().type));e(p).append(N.generate({},""!=v["registration-link"]?"login":s,"sb-init-form")),this.dashboard||this.showDashboard(),this.dashboard=!0,this.finalizeInit(),e(n).addClass("sb-init-form-active")},activateBar:function(t=!0){e(u).find(".sb-bar").sbActivate(t)},addUserAndLogin:function(e=!1){E.ajax({function:"add-user-and-login",login_app:R.login()},t=>{E.loginCookie(t[1]),a(new M(t[0])),!1!==e&&e(t)})},isInitDashboard:function(){return v["init-dashboard"]||0!=a()&&a().conversations.length>1},uploadResponse:function(t){if("success"==(t=JSON.parse(t))[0])if("extension_error"==t[1])E.dialog("The file you are trying to upload has an extension that is not allowed.","info");else if(e(r).hasClass("sb-input-image"))e(r).find(".image").attr("data-value","").css("background-image",""),setTimeout(()=>{e(r).find(".image").attr("data-value",t[1]).css("background-image",`url("${t[1]}?v=${E.random()}")`).append('<i class="sb-icon-close"></i>'),r=!1},500);else{let s=t[1].substr(t[1].lastIndexOf("/")+1);e(u).find(".sb-attachments").append(`<div data-name="${s}" data-value="${t[1]}">${s}<i class="sb-icon-close"></i></div>`),D.activateBar()}else E.error(t[1],"sb-upload-files.change");this.busy(!1)}};window.SBChat=D;var N={rich_messsages:{email:"",button:"",video:"",image:"","woocommerce-button":"",chips:'<div class="sb-buttons">[options]</div>',buttons:'<div class="sb-buttons">[options]</div>',select:'<div class="sb-select"><p></p><ul>[options]</ul></div>',list:'<div class="sb-text-list">[values]</div>',"list-image":'<div class="sb-image-list">[values]</div>',table:"<table><tbody>[header][values]</tbody></table>",inputs:'<div class="sb-form">[values]</div>',rating:`<div class="sb-rating"><div class="sb-input sb-input-textarea"><textarea></textarea></div><div><div data-rating="positive" class="sb-submit"><i class="sb-icon-like"></i>${i("Good")}</div><div data-rating="negative" class="sb-submit"><i class="sb-icon-dislike"></i>${i("Bad")}</div></div></div>`,card:'<div class="sb-card">[settings]</div>',share:'<div class="sb-social-buttons">[settings]</div>',slider:'<div class="sb-slider"><div>[items]</div></div><div class="sb-slider-arrow sb-icon-arrow-left[class]"></div><div class="sb-slider-arrow sb-icon-arrow-right sb-active[class]"></div>',"slider-images":'<div class="sb-slider sb-slider-images"><div>[items]</div></div><div class="sb-slider-arrow sb-icon-arrow-left[class]"></div><div class="sb-slider-arrow sb-icon-arrow-right sb-active[class]"></div>'},cache:{},generate:function(t,s,o=""){let r,l=!0,c="id"in t?t.id:E.random();if(s in this.rich_messsages)r=this.rich_messsages[s];else if(s in this.cache)r=this.cache[s];else{if(!v["rich-messages"].includes(s))return!1;r='<div class="sb-rich-loading sb-loading"></div>',E.ajax({function:"get-rich-message",name:s},t=>{t=this.initInputs(t),"timetable"==s&&(t=this.timetable(t)),e(n).find(`.sb-rich-message[id="${c}"]`).html(`<div class="sb-content">${t}</div>`),this.cache[s]=t,D.scrollBottom(D.dashboard)}),l=!1}if(l){let n,o="";switch(s){case"email":let l="last-name"in t?a().get("first_name"):a().name,c=a().get("last_name"),u=a().get("email");"#"==c.charAt(0)&&(l=c=""),r=("name"in t&&"true"==t.name?`<div id="first_name" data-type="text" class="sb-input sb-input-text"><span class="${""==l?"":"sb-active sb-filled"}">${i("last-name"in t&&"true"==t["last-name"]?"First name":"Name")}</span><input value="${l}" autocomplete="false" type="text" required></div>`:"")+("last-name"in t&&"true"==t["last-name"]?`<div id="last_name" data-type="text" class="sb-input sb-input-text"><span class="${""==c?"":"sb-active sb-filled"}">${i("Last name")}</span><input value="${c}" autocomplete="false" type="text" required></div>`:"")+`<div id="email" data-type="email" class="sb-input sb-input-btn"><span class="${""==u?"":"sb-active sb-filled"}">${i("placeholder"in t?t.placeholder:"Email")}</span><input value="${u}" autocomplete="off" type="email" required><div class="sb-submit sb-icon-arrow-right"></div></div>`;break;case"image":r=`<div class="sb-image"><img src="${t.url}"></div>`;break;case"video":r=`<iframe${"height"in t?` height="${t.height}"`:""} src="${"youtube"==t.type?"//www.youtube.com/embed/":"//player.vimeo.com/video/"}${t.id}" allowfullscreen></iframe>`;break;case"select":n=t.options.split(",");for(d=0;d<n.length;d++)o+=`<li data-value="${E.stringToSlug(n[d])}">${i(n[d])}</li>`;r=r.replace("[options]",o);break;case"chips":case"buttons":n=t.options.split(",");for(d=0;d<n.length;d++)o+=`<div class="sb-btn sb-submit">${i(n[d])}</div>`;r=r.replace("[options]",o);break;case"button":r=`<a href="${t.link.replace(/<i>/g,"_").replace(/<\/i>/g,"_")}"${"target"in t?' target="_blank"':""} class="sb-rich-btn sb-btn${"link"==t.style?"-text":""}">${i(t.name)}</a>`;break;case"list":n=t.values.split(",");let h="list"==s,g=h&&n.length&&n[0].indexOf(":")>0;h&&!g&&(r=r.replace("sb-text-list","sb-text-list sb-text-list-single"));for(d=0;d<n.length;d++)o+=g?`<div><div>${i(n[d].split(":")[0])}</div><div>${i(n[d].split(":")[1])}</div></div>`:`<div>${e.trim(i(n[d]))}</div>`;r=r.replace("[values]",o);break;case"list-image":n=t.values.split(",");for(d=0;d<n.length;d++){let e=n[d].replace("://","///").split(":");o+=`<div><div class="sb-thumb" style="background-image:url('${e[0].replace("///","://")}')"></div><div class="sb-list-title">${e[1]}</div><div>${e[2]}</div></div>`}r=r.replace("[values]",o);break;case"table":n=t.header.split(","),o+="<tr>";for(d=0;d<n.length;d++)o+=`<th>${n[d]}</th>`;o+="</tr>",r=r.replace("[header]",o),o="",n=t.values.split(",");for(d=0;d<n.length;d++){let e=n[d].split(":");o+="<tr>";for(d=0;d<e.length;d++)o+=`<td>${e[d]}</td>`;o+="</tr>"}r=r.replace("[values]",o);break;case"inputs":n=t.values.split(",");for(d=0;d<n.length;d++)o+=`<div id="${E.stringToSlug(n[d])}" data-type="text" class="sb-input sb-input-text"><span>${i(n[d])}</span><input autocomplete="false" type="text" required></div>`;o+='<div class="sb-btn sb-submit">'+i("button"in t?t.button:"Send now")+"</div>",r=r.replace("[values]",o);break;case"card":o=`${"image"in t?`<div class="sb-card-img" style="background-image:url(${t.image})"></div>`:""}<div class="sb-card-header">${t.header}</div>${"extra"in t?`<div class="sb-card-extra">${t.extra}</div>`:""}${"description"in t?`<div class="sb-card-description">${t.description}</div>`:""}${"link"in t?`<a class="sb-card-btn" href="${t.link}">${i(t["link-text"])}</a>`:""}`,r=r.replace("[settings]",o);break;case"share":let m="channels"in t?t.channels.split(","):["fb","tw","li","wa","pi"],f="";for(d=0;d<m.length;d++){let e=m[d];switch(e){case"fb":f="www.facebook.com/sharer.php?u=";break;case"tw":f="twitter.com/intent/tweet?url=";break;case"li":f="www.linkedin.com/sharing/share-offsite/?url=";break;case"wa":f="web.whatsapp.com/send?text=";break;case"pi":f="www.pinterest.com/pin/create/button/?url="}o+=`<div class="sb-${e} sb-icon-social-${e}" data-link="https://${f}${t.link}"></div>`}r=r.replace("[settings]",o);break;case"slider":let p=0;for(d=1;d<16&&"header-"+d in t;d++)o+=`<div>${"image-"+d in t?`<div class="sb-card-img" style="background-image:url(${t["image-"+d]})"></div>`:""}<div class="sb-card-header">${t["header-"+d]}</div>${"extra-"+d in t?`<div class="sb-card-extra">${t["extra-"+d]}</div>`:""}${"description-"+d in t?`<div class="sb-card-description">${t["description-"+d]}</div>`:""}${"link-"+d in t?`<a class="sb-card-btn" href="${t["link-"+d]}">${i(t["link-text-"+d])}</a>`:""}</div>`,p++;r=r.replace("[items]",o).replace(/\[class\]/g,1==p?" sb-hide":"");break;case"slider-images":if("images"in t){let e=t.images.split(",");for(var d=0;d<e.length;d++)o+=`<div class="sb-card-img" data-value="${e[d]}" style="background-image:url(${e[d]})"></div>`;r=r.replace(/\[class\]/g,1==e.length?" sb-hide":"")}r=r.replace("[items]",o);break;case"woocommerce-button":t.settings=`checkout:${t.checkout},coupon:${t.coupon}`,r=`<a href="#" data-ids="${t.ids}" class="sb-rich-btn sb-btn">${t.name}</a>`}}return`<div id="${c}" data-type="${s}"${"disabled"in t?'disabled="true"':""}${"settings"in t?` data-settings="${t.settings}"`:""}class="sb-rich-message sb-rich-${s} ${o}">`+("title"in t?`<div class="sb-top">${i(t.title)}</div>`:"")+("message"in t?`<div class="sb-text">${i(t.message)}</div>`:"")+`<div class="sb-content">${r}</div><div data-success="${"success"in t?t.success.replace(/"/g,""):""}" class="sb-info"></div></div>`},submit:function(t,s,o){if(!l&&!e(o).sbLoading()&&!this.is_busy){let l="",c="",d={},u=e(t).find("[data-success]").length?e(t).find("[data-success]").attr("data-success"):"",h=e(t).closest(".sb-rich-message").attr("id"),g=e(t).closest("[data-id]").attr("data-id"),m="",f={"rich-messages":{}},p=0==a()?{profile_image:["",""],first_name:["",""],last_name:["",""],email:["",""],password:["",""],user_type:["",""]}:{profile_image:[a().image,""],first_name:[a().get("first_name"),""],last_name:[a().get("last_name"),""],email:[a().get("email"),""],password:["",""],user_type:["",""]},y={},k=o,$="",C=!1!==D.conversation;if(E.null(g))g=-1;else{let e=D.conversation.getMessage(g);m=e.get("message"),"rich-messages"in(f=e.payload())||(f["rich-messages"]={})}switch(e(o).hasClass("sb-btn")||e(o).hasClass("sb-select")||e(o).hasClass("sb-submit")||(k=e(o).closest(".sb-btn,.sb-select")),e(k).sbLoading(!0),e(t).find(".sb-info").html("").sbActivate(!1),s){case"email":"first_name"in(y=U.getAll(t))&&(p.user_type=["user",""],"last_name"in y||(p.last_name=["",""])),e.extend(p,y),l="Please insert a valid email."+("first_name"in y?"":" All fields are required."),u=""==u?u:i(u)+` *${p.email[0]}*`,f["rich-messages"][h]={type:s,result:y},f.event="update-user",d={function:"update-user-and-message",settings:p,payload:f},$="email-complete";break;case"chips":case"select":case"buttons":y=E.escape(e(o).html()),u=""==u?u:i(u)+` *${y}*`,f["rich-messages"][h]={type:s,result:y},d={function:"update-message",payload:f},$=y,"chips"==s&&(D.sendMessage(a().id,y,[],!1,{id:h,event:"chips-click",result:y}),e(o).closest(".sb-content").remove());break;case"inputs":if(y=U.getAll(t),l="All fields are required.",""!=u){u=i(u)+' [list values="';for(var r in y)u+=`${i(y[r][1].replace(/:|,/g,""))}:${y[r][0].replace(/:|,/g,"")},`;u=u.slice(0,-1)+'"]'}f["rich-messages"][h]={type:s,result:y},d={function:"update-message",payload:f},$="inputs-complete";break;case"registration":let n,c=U.getAll(t.find(".sb-form-extra"));e.extend(p,U.getAll(t.find(".sb-form-main"))),n=e.extend({},p),u=`${i(""==u?"Your account details are as follows:":u)} [list values="`;for(var r in p){let e=p[r][0].replace(/:|,/g,"");""!=e&&("profile_image"==r&&(e=e.substr(e.lastIndexOf("/")+1)),"password"!=r&&"password-check"!=r||(e="********",n[r]="********"),u+=""==p[r][1]?"":`${i(p[r][1].replace(/:|,/g,""))}:${e},`)}for(var r in c)""!=c[r][0]&&(u+=`${i(c[r][1].replace(/:|,/g,""))}:${c[r][0].replace(/:|,/g,"")},`);p.user_type=["user",""],u=u.slice(0,-1)+'"]',f["rich-messages"][h]={type:s,result:{user:n,extra:c}},f.event="update-user",d={function:0!=a()?"update-user-and-message":"add-user-and-login",settings:p,settings_extra:c,payload:f},l=U.getRegistrationErrorMessage(t),$="registration-complete";break;case"rating":let g=e(o).attr("data-rating");u=`${i("Your rating is")} *${i(g)}*. ${i(""==u?"Thank you for your feedback!":u)}`,y={conversation_id:D.conversation.id,agent_id:D.agent_id,user_id:a().id,message:t.find("textarea").val(),rating:"positive"==g?1:-1},f["rich-messages"][h]={type:s,result:y},d={function:"set-rating",payload:f,settings:y},$=g}if(c=m.substr(m.indexOf("["+s)),c=c.substr(0,c.indexOf("]")+1),""!=l&&U.errors(t))return U.showErrorMessage(t,l),e(k).sbLoading(!1),(D.dashboard||C&&D.conversation.getLastMessage().id==g)&&D.scrollBottom(),!1;if(""==u){let e=this.shortcode(c),t="title"in e[1]?`title="${e[1].title}"`:"",i="message"in e[1]?`message="${e[1].message}"`:"",a="";if(["inputs","email"].includes(s)){for(var r in y)a+=y[r][0]+",";a=`values="${a.slice(0,-1)}"`}else a=`options="${y}"`;u=`[${"email"==s?"inputs":s} ${t} ${i} ${a} disabled="true"]`}-1!=g&&e.extend(d,{message_id:g,message:""!=m?m.replace(c,u):u,payload:f}),E.ajax(d,i=>{if(0==i||E.errorValidation(i))U.showErrorMessage(t,U.getRegistrationErrorMessage(i,"response")),D.dashboard&&D.scrollBottom(),e(k).sbLoading(!1);else{switch(s){case"email":for(var r in p)a().set(r,p[r][0]);C&&!1!==D.conversation.getLastUserMessage()&&v["notify-agent-email"]&&D.sendEmail(D.conversation.getLastUserMessage().get("message")),E.loginCookie(i[1]),"sb-subscribe-form"==h&&E.ajax({function:"subscribe-email",email:a().get("email")}),E.event("SBNewEmailAddress",{id:h,name:a().name,email:a().get("email")});break;case"registration":if(E.loginCookie(i[1]),0==a())a(new M(i[0])),D.initChat(),D.sendMessage(b,u);else for(var r in p)a().set(r,p[r][0]);D.dashboard&&(e(n).removeClass("sb-init-form-active"),e(t).remove(),D.isInitDashboard()||D.hideDashboard()),delete this.cache.registration,E.event("SBRegistrationForm",{id:h,user:p,extra:f["rich-messages"][h].result.extra}),E.event("SBNewEmailAddress",{id:h,name:a().name,email:a().get("email")})}-1==g?e(o).closest(".sb-rich-message").html(u):"type"in f&&"close-message"==f.type||w||0!=_||D.setConversationStatus(2),["email","registration","login","chips"].includes(s)||D.sendBotMessage(`${h}|${s}|${$}`),v["slack-active"]&&D.slackMessage(a().id,a().name,a().image,u),E.event("SBRichMessageSubmit",{result:i,data:f["rich-messages"][h],id:h})}})}},shortcode:function(t){if(t.indexOf(" ")<0)return[t.slice(1,-1),{}];let s={},i=t.substr(1,t.indexOf(" ")-1),a=(t=t.slice(1,-1).substr(i.length+1)).split('" ');for(var n=0;n<a.length;n++)if(a[n].indexOf("=")>-1){let t=[a[n].substr(0,a[n].indexOf("=")),a[n].substr(a[n].indexOf("=")+2)];s[e.trim(t[0])]=t[1].replace(/"/g,"")}return[i,s]},initInputs:function(t){return t=e.parseHTML("<div>"+t+"</div>"),e(t).find(".sb-input input").each(function(){""!=e(this).val()&&e(this).siblings().addClass("sb-active sb-filled")}),e(t).html()},timetable:function(t){let s=e.parseHTML(`<div>${t}</div>`),a=e(s).find("[data-offset]").attr("data-offset");return a=""==a?0:parseInt(a),e(s).find("[data-time]").each(function(){let n=e(this).attr("data-time").split("|");t="";for(var o=0;o<n.length;o++){if("closed"==n[o]){t+=i("Closed");break}if(""!=n[o]){let e=parseInt(n[o].split(":")[0])+a-S.getTimezoneOffset()/60,s=n[o].split(":")[1];e>24&&(e-=24),e<0&&(e=24-e);let r=new Date(`01/01/2000 ${e}:${s} UTC`);t+=r.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})+(0==o||2==o?`<span>${i("to")}</span>`:1==o&&""!=n[o+1]?"<br />":"")}}e(s).find(" > div > span").html(`<i class="sb-icon-clock"></i> ${i("Time zone")} ${Intl.DateTimeFormat().resolvedOptions().timeZone}`),e(this).html(t)}),e(s).html()},sliderChange:function(t,s="left"){let i=e(d).find(`#${t}`);if(i.length&&!e(i).hasClass("sb-moving")){let t=e(i).find(".sb-slider > div > div"),a=e(t).eq(0),n=Math.ceil(e(a).closest(".sb-slider").width()),o="right"==s?-1:1,r=parseFloat(parseFloat(parseFloat(e(a).css("margin-left"))+n*o).toFixed(2))+-.5*o,l=n*(t.length-1)*-1;r<1&&r>=l&&(e(a).css("margin-left",r+"px"),e(i).addClass("sb-moving"),setTimeout(()=>{e(i).removeClass("sb-moving")},1200)),e(i).find(".sb-icon-arrow-right").sbActivate(!(l>r-15&&l<r+15)),e(i).find(".sb-icon-arrow-left").sbActivate(r<-10)}}},U={getAll:function(t){let s={};return e(t).find(".sb-input[id]").each((t,i)=>{s[e(i).attr("id")]=this.get(i)}),s},get:function(t){let s=e(t).data("type"),a=i(E.escape(e(t).find(" > span").html()));switch(s){case"image":let i=e(t).find(".image").attr("data-value");return[E.null(i)?"":i,a];case"select":return[E.escape(e(t).find("select").val()),a];default:let n=e(t).find("input");return[E.escape(e(n).length?e(n).val():e(t).find("[data-value]").attr("data-value")),a]}},set:function(t,s){if(e(t).length){switch(e(t).data("type")){case"image":""==s?e(t).find(".image").removeAttr("data-value").removeAttr("style"):e(t).find(".image").attr("data-value",s).css("background-image",`url("${s}")`);break;case"select":e(t).find("select").val(s);break;default:e(t).find("input").val(s)}return!0}return!1},clear:function(t){e(t).find(".sb-input").each((e,t)=>{this.set(t,"")}),this.set(e(t).find("#user_type"),"user")},errors:function(t){let s=!1,i=e(t).find("[required]").removeClass("sb-error");return e(i).each(function(t){let a=e(this).attr("type"),n=e(this).val();""==n?s=!0:"password"==a?"password"==a&&(n.length<8||i.length>t+1&&"password"==e(i[t+1]).attr("type")&&e(i[t+1]).val()!=n)&&(s=!0):"email"==a&&(n.indexOf("@")<0||n.indexOf(".")<0)&&(s=!0),s&&e(this).addClass("sb-error")}),i=e(t).find("[data-required]").removeClass("sb-error"),e(i).each(function(){E.null(e(this).attr("data-value"))&&(e(this).addClass("sb-error"),s=!0)}),s},showErrorMessage:function(t,s){e(t).find(".sb-info").html(i(s)).sbActivate(),clearTimeout(k),k=setTimeout(function(){e(t).find(".sb-info").sbActivate(!1)},7e3)},showSuccessMessage:function(t,s){e(t).find(".sb-info").remove(),e(t).addClass("sb-success").find(".sb-content").html(`<div class="sb-text">${s}</div>`)},getRegistrationErrorMessage(t,s="validation"){if("response"==s)return E.errorValidation(t,"duplicate-email")?"This email is already in use. Please use another email.":"Error. Please check your information and try again.";let i=e(t).find("#last_name").length?"first name, last name":"name";return e(t).find("#password").length?`Please insert your ${i}, a valid email, and a password (8 character minimum).`:`Please insert your ${i}, and a valid email.`}};window.SBForm=U;var R={login:function(){return!!this.is("wp")&&("wp"==v["wp-users-system"]&&(typeof SB_WP_ACTIVE_USER!=B&&SB_WP_ACTIVE_USER))},is:function(e){return("wordpress"==e||"wp"==e)&&v.wp},wordpress:{ajax:function(t,s,i){e.ajax({method:"POST",url:SB_WP_AJAX_URL,data:e.extend({action:"sb_wp_ajax",type:t},s)}).done(e=>{!1!==i&&i(e)})},isLogin:function(){return v.wp&&typeof SB_WP_ACTIVE_USER!=B&&!1!==SB_WP_ACTIVE_USER}},woocommerce:{updateCart:function(e,t,s=!1){R.wordpress.ajax(e,{product_id:t},s)},waitingList:function(e="request",t=!1){typeof SB_WP_WAITING_LIST!==B&&("request"!=e||SB_WP_WAITING_LIST&&E.storageTime("waiting-list-"+SB_WP_PAGE_ID,24))&&a()&&E.ajax({function:"woocommerce-waiting-list",product_id:!1===t?SB_WP_PAGE_ID:t,conversation_id:D.conversation.id,action:e,token:D.dialogflow_token},t=>{t&&(E.storageTime("waiting-list-"+SB_WP_PAGE_ID),"request"!=e||D.chat_open&&!D.dashboard||D.updateConversations())})}},dialogflow:{active:function(e=!0){return!1===e?(v["dialogflow-active"]=!1,E.storageTime("dialogflow"),!1):v["dialogflow-active"]&&!l&&E.storageTime("dialogflow",1)&&(!v["bot-office-hours"]||!v["office-hours"])},unknowEmail:function(e){return D.sendEmail(`${e}<br><br><span style="color:#a8a8a8;font-size: 12px;">${i("This message has been sent because the Dialogflow Bot does not know the answer to the user's question.")}</span>`)},welcome:function(){v["dialogflow-welcome"]&&E.ajax({function:"send-bot-message",message:"",conversation_id:D.conversation.id,token:D.dialogflow_token,event:"Welcome"})}}};e(document).ready(function(){n=e("body").find(".sb-admin, .sb-chat, .sb-tickets"),l=e(n).hasClass("sb-admin")||!n.length,y=e(n).hasClass("sb-tickets"),n.length&&typeof SB_AJAX_URL!=B?(d=e(n).find(".sb-list"),u=e(n).find(".sb-editor"),h=e(u).find("textarea"),p=e(n).find(l||y?".sb-list":"> div > .sb-scroll-area"),g=e(p).find(".sb-header"),f=e(u).find(".sb-emoji"),m=y?e(n).find(".sb-profile-agent .sb-status"):null,D.enabledAutoExpand(),D.audio=e(n).find("#sb-audio")[0],D.audio_out=e(n).find("#sb-audio-out")[0],E.cookie("sb-check","ok",1,"set"),"ok"!=E.cookie("sb-check")?(T=!1,console.warn("Support Board: cookies not available.")):E.cookie("sb-check",!1,!1,!1),0!=s("login")&&(E.loginCookie(s("login")),localStorage.removeItem("login")),E.ajax({function:"get-front-settings"},e=>{b=(v=e)["bot-id"],_=v["dialogflow-human-takeover"],w=v["bot-unknow-notify"],A=v["agents-online"],l||v["chat-manual-init"]||v["disable-offline"]&&!A||v["disable-office-hours"]&&!v["office-hours"]||!(!v["chat-login-init"]||!R.is("wp")&&E.cookie("sb-login")||R.is("wp")&&R.wordpress.isLogin())||D.initChat(),v.cron&&setTimeout(function(){E.ajax({function:"cron-jobs"})},1e4),E.event("SBReady")}),e(u).on("keydown","textarea",function(e){if(!(13!=e.which||y||l&&e.ctrlKey))return D.submit(),e.preventDefault,!1;l&&13==e.which&&e.ctrlKey&&D.insertText("\n")}),l||(D.audio_out.volume=.4),typeof SB_DEFAULT_DEPARTMENT!==B&&(D.default_department=SB_DEFAULT_DEPARTMENT)):(v=[],E.event("SBReady")),document.addEventListener("visibilitychange",function(){E.visibilityChange(document.visibilityState)},!1),e(n).on("click",function(){0==D.tab_active&&E.visibilityChange()}),l?(o=n,n=e(n).find(".sb-conversation")):o=n,e(p).on("scroll",function(e){D.scrollHeader()}),e(d).on("click",".sb-menu-btn",function(){let t=e(this).parent().find(".sb-menu"),s=e(t).sbActive();E.deactivateAll(),s||(e(t).sbActivate(),E.deselectAll())}),C&&(e(u).on("click",".sb-textarea",function(){e(n).addClass("sb-header-hidden"),e(this).find("textarea").focus(),p[0].scrollTop===p[0].scrollHeight-p[0].offsetHeight&&(D.scrollBottom(),setTimeout(()=>{D.scrollBottom()},200))}),e(u).on("focusout",".sb-textarea",function(){setTimeout(()=>{e(n).removeClass("sb-header-hidden")},300)}),e(u).on("click",".sb-submit",function(){e(h).blur()})),e(d).on("click",".sb-menu li",function(){e(this).parent().sbActivate(!1)}),e(d).on("click",'.sb-menu [data-value="delete"]',function(){let t=e(this).closest("[data-id]"),s=e(t).attr("data-id");D.user_online?E.ajax({function:"update-message",message_id:s,message:"",attachments:[],payload:{event:"delete-message"}},()=>{D.conversation.deleteMessage(s),e(d).find(`[data-id="${s}"]`).remove()}):D.deleteMessage(s)}),e(u).on("click",".sb-submit",function(){D.submit()}),e("body").on("click",".sb-chat-btn,.sb-responsive-close-btn,#sb-open-chat,.sb-open-chat",function(){D.open(!D.chat_open)}),e(n).on("click",".sb-dashboard-btn",function(){D.showDashboard(),s("open-conversation",0),x=!1}),e(n).on("click",".sb-user-conversations li",function(){D.openConversation(e(this).attr("data-conversation-id"))}),e(n).on("click",".sb-btn-new-conversation,.sb-departments-list > div",function(){E.null(e(this).data("id"))||(D.default_department=parseInt(e(this).data("id"))),x="new-conversation",D.clear(),D.hideDashboard()}),e(u).on("click",".sb-btn-attachment",function(){D.is_busy||e(u).find(".sb-upload-files").val("").click()}),e(u).on("click",".sb-attachments > div > i",function(t){return e(this).parent().remove(),""==e(h).val()&&0==e(u).find(".sb-attachments > div").length&&D.activateBar(!1),t.preventDefault(),!1}),e(u).on("change",".sb-upload-files",function(t){D.busy(!0),e(this).sbUploadFiles(function(e){D.uploadResponse(e)}),E.event("SBAttachments")}),e(u).on("dragover",function(){e(this).addClass("sb-drag"),clearTimeout(k)}),e(u).on("dragleave",function(){k=setTimeout(()=>{e(this).removeClass("sb-drag")},200)}),e(u).on("drop",function(t){let s=t.originalEvent.dataTransfer.files;if(t.preventDefault(),t.stopPropagation(),s.length>0)for(var i=0;i<s.length;++i){let e=new FormData;e.append("file",s[i]),E.upload(e,function(e){D.uploadResponse(e)})}e(this).removeClass("sb-drag")}),e(n).on("click",".sb-btn-all-articles",function(){D.showArticles()}),e(n).on("click",".sb-articles > div",function(){D.showArticles(e(this).attr("data-id"))}),e(n).on("click",".sb-dashboard-articles .sb-input-btn .sb-submit-articles",function(){D.searchArticles(e(this).parent().find("input").val(),this)}),e(d).on("click",".sb-rich-button a",function(t){let s=e(this).attr("href");if(0===s.indexOf("#")&&0===s.indexOf("#article-"))return D.showArticles(s.replace("#article-","")),t.preventDefault(),!1}),e(o).on("click",".sb-lightbox-media > i",function(){return e(o).find(".sb-lightbox-media").sbActivate(!1),!1}),e(n).on("click",".sb-image",function(){E.lightbox(e(this).html())}),e(n).on("click",".sb-slider-images .sb-card-img",function(){E.lightbox(`<img src="${e(this).attr("data-value")}" />`)}),e(window).on("SBConversationLoaded",function(){s("queue")&&D.queue(s("queue"))}),e(u).on("click",".sb-btn-emoji",function(){D.showEmoji(this)}),e(f).on("click",".sb-emoji-list li",function(t){D.insertEmoji(e(this).html()),C&&clearTimeout(k)}),e(f).find(".sb-emoji-list").on("touchend",function(e){k=setTimeout(()=>{D.mouseWheelEmoji(e)},50)}),e(f).find(".sb-emoji-list").on("mousewheel DOMMouseScroll",function(e){D.mouseWheelEmoji(e)}),e(f).find(".sb-emoji-list").on("touchstart",function(e){D.emoji_options.touch=e.originalEvent.touches[0].clientY}),e(f).on("click",".sb-emoji-bar > div",function(){D.clickEmojiBar(this)}),e(f).on("click",".sb-select li",function(){D.categoryEmoji(e(this).data("value"))}),e(f).find(".sb-search-btn input").on("change keyup paste",function(){D.searchEmoji(e(this).val())}),e(h).on("keyup",function(){D.textareaChange(this)}),e(n).on("click",".sb-privacy .sb-approve",function(){s("privacy-approved",!0),e(this).closest(".sb-privacy").remove(),e(n).removeClass("sb-init-form-active"),e(g).find(" > div").css({opacity:1,top:0}),D.initChat(),y?SBTickets.showPanel("new-ticket"):D.isInitDashboard()||D.hideDashboard()}),e(n).on("click",".sb-privacy .sb-decline",function(){let t=e(this).closest(".sb-privacy");e(t).find(".sb-text").html(e(t).attr("data-decline")),e(t).find(".sb-decline").remove(),D.scrollBottom(!0)}),e(n).on("click",".sb-popup-message .sb-icon-close",function(){D.popup(!0)}),e(n).on("click",".sb-rich-message .sb-submit,.sb-rich-message .sb-select ul li",function(){let t=e(this).closest(".sb-rich-message");t[0].hasAttribute("disabled")||N.submit(t,t.attr("data-type"),this)}),e(n).on("click",".sb-rich-message .sb-input > span",function(){e(this).sbActivate(),e(this).siblings().focus()}),e(n).on("focus",".sb-rich-message .sb-input input",function(){e(this).siblings().sbActivate()}),e(n).on("click",".sb-rich-message .sb-input input",function(){e(this).siblings().removeClass("sb-filled")}),e(n).on("focusout",".sb-rich-message .sb-input input",function(){""==e(this).val()?e(this).siblings().sbActivate(!1):e(this).siblings().addClass("sb-filled sb-active")}),e(n).on("click",".sb-slider-arrow",function(){N.sliderChange(e(this).closest("[id]").attr("id"),e(this).hasClass("sb-icon-arrow-right")?"right":"left")}),e(n).on("click",".sb-rich-registration .sb-login-area",function(){e(this).closest(".sb-rich-registration").replaceWith(N.generate({},"login","sb-init-form")),D.scrollBottom(!0)}),e(n).on("click",".sb-rich-login .sb-registration-area",function(){""!=v["registration-link"]?document.location=v["registration-link"]:(e(this).closest(".sb-rich-login").replaceWith(N.generate({},"registration","sb-init-form")),D.scrollBottom(!0))}),e(n).on("click",".sb-rich-login .sb-submit-login",function(){E.loginForm(this,!1,t=>{a(new M(t[0])),e(n).removeClass("sb-init-form-active"),e(this).closest(".sb-rich-login").remove(),x="open-conversation",D.initChat(),D.isInitDashboard()||D.hideDashboard()})}),e(d).on("click",".sb-social-buttons div",function(){E.openWindow(e(this).attr("data-link"))}),e(d).on("click",'.sb-rich-woocommerce-button a, [href="#"].sb-card-btn',function(t){if(!e(this).sbLoading()){let t=E.settingsStringToArray(e(this).closest(".sb-rich-message").attr("data-settings")),s="checkout"==t["link-type"]||t.checkout,i=e(this)[0].hasAttribute("data-ids")?e(this).attr("data-ids").split(","):[t.id.split("|")[e(this).parent().index()]];i.length&&(e(this).sbLoading(!0),R.wordpress.ajax("button-purchase",{product_ids:i,checkout:s,coupon:t.coupon},t=>{s?document.location=t:e(this).addClass("sb-icon-check").sbLoading(!1)}))}return t.preventDefault(),!1}),e(d).on("click","#sb-waiting-list .sb-submit",function(){0==e(this).index()&&setTimeout(()=>{R.woocommerce.waitingList("submit")},1e3)}),e(window).on("SBNewEmailAddress",function(e,t){"sb-waiting-list-email"==t.id&&R.woocommerce.waitingList("submit")}),e(o).on("click",".sb-search-btn > i",function(){e(this).parent().toggleClass("sb-active"),e(this).parent().find("input").focus(),e(o).find(".sb-select ul").sbActivate(!1)}),e(o).on("click",".sb-select",function(){e(this).find("ul").toggleClass("sb-active")}),e(o).on("click",".sb-select li",function(){let t=e(this).closest(".sb-select"),s=e(this).data("value");var i=e(t).find(`[data-value="${s}"]`);e(t).find("li").sbActivate(!1),e(t).find("p").attr("data-value",s).html(e(i).html()),e(i).sbActivate()}),e(o).on("click",".sb-input-image .image",function(){r=e(this).parent(),e(u).find(".sb-upload-files").click()}),e(o).on("click",".sb-input-image .image > .sb-icon-close",function(t){return e(this).parent().removeAttr("data-value").css("background-image",""),t.preventDefault(),!1})})}(jQuery);